let ysdk;const PlayerStatsManager={pendingStats:{},saveTimeout:null,lastSaveTime:0,SAVE_DELAY:5e3,lastSubmitTime:0,SUBMIT_DELAY:1e3,init(){document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?(this.forceSave(),musicOnPause(!0)):musicOnPause(!1)})),window.addEventListener("beforeunload",(()=>{this.forceSave()}))},update(e){this.pendingStats={...this.pendingStats,...e};const t=Date.now()-this.lastSaveTime;t>=this.SAVE_DELAY?this.save():(clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout((()=>this.save()),this.SAVE_DELAY-t))},prepareChanges(){const e={currency:game.currency,bestScore:game.bestScore,hasEnteredBefore:!0,displayMode:game.displayMode,lastClaimDate:game.lastClaimDate,lastDailyReward:game.lastDailyReward,currentGame:{...getSnapshotBoard(),history:game.historyStack.map((e=>({score:e.score,highestLevelReached:e.highestLevelReached,grid:e.grid.map((e=>e.map((e=>e?{value:e.value}:null))))})))}};this.update(e)},save(){ysdk&&ysdk.getPlayer&&ysdk.getPlayer().then((e=>e.setData(this.pendingStats))).then((()=>{this.pendingStats={},this.lastSaveTime=Date.now()})).catch((e=>{}))},forceSave(){Object.keys(this.pendingStats).length>0&&this.save()},trySubmitScore(e){ysdk.getPlayer().then((t=>{"lite"===t.getMode()||this.submitScore(e)})).catch((e=>{}))},submitScore(e){const t=Date.now();t-this.lastSubmitTime<this.SUBMIT_DELAY||(this.lastSubmitTime=t,ysdk.getLeaderboards().then((t=>{t.setLeaderboardScore("lbBestScore",e).then((()=>{})).catch((e=>{}))})).catch((e=>{})))}},SoundManager={sounds:{},musicEnabled:!0,effectsEnabled:!0,load(e,t,a=!1){const n=document.createElement("audio");for(const o of t){const t=this.getMimeType(o);if(n.canPlayType(t))return n.src=o,n.preload="auto",n.loop=a,void(this.sounds[e]=n)}},getMimeType:e=>e.endsWith(".mp3")?"audio/mpeg":e.endsWith(".m4a")?"audio/mp4":e.endsWith(".ogg")?"audio/ogg":"",play(e){if(!this.effectsEnabled)return;const t=this.sounds[e];t&&!t.loop&&(t.volume=.1,t.currentTime=0,t.play().catch((e=>{})))},playMusic(e){if(!this.musicEnabled)return;const t=this.sounds[e];t&&t.loop&&(t.volume=.01,t.play().catch((e=>{})))},stop(e){const t=this.sounds[e];t&&(t.pause(),t.currentTime=0)},pause(e){const t=this.sounds[e];t&&t.pause()},toggleMusic(e){this.musicEnabled=e,e||this.pause("bg")},toggleSound(e){if(this.effectsEnabled=e,!e)for(const e of Object.values(this.sounds))e.pause(),e.currentTime=0}},game={preloaderImages:[],grid:[],gap:2,tileSize:0,cellSize:0,gridSize:4,typeModes:{level:"level",value:"value"},displayMode:null,highestLevelReached:2,gridElement:document.getElementById("grid"),settingsOverlay:document.getElementById("settings-overlay"),elBestScore:document.getElementById("best"),elCurrency:document.getElementById("currency"),elScore:document.getElementById("score"),destroyPanel:document.getElementById("destroy-mode-panel"),swapPanel:document.getElementById("swap-mode-panel"),selectedTiles:[],historyStack:[],HISTORY_LIMIT:10,isMusicOn:!1,musicReady:!1,musicStarted:!1,isSoundOn:!1,swapMode:!1,destroyMode:!1,isPlaying:!1,isPaused:!1,isMove:!1,hasEnteredBefore:!1,currency:0,bestScore:0,score:0,lastClaimDate:null,lastDailyReward:null,player:{},log2Cache:{},colorCache:{},predefinedTileColors:{},randomLevelUpPhrases:[],randomNoCurrencyPhrases:[],lastAdTimestamp:0,lastInteractionTime:null,lang:null,langs:["ru","en"],currentLang:"ru",translations:{},dailyReward:395,videoReward:250,undoPrice:130,destroyPrice:120,swapPrice:150,currencyStart:100,intervalSmartAd:3e3};function initGame(e){return createGrid(),initTilePool(),syncTileSizeWithCell(),initDefaultSettings(),game.isMusicOn="false"!==localStorage.getItem("music"),game.isSoundOn="false"!==localStorage.getItem("sound"),game.lastAdTimestamp=Number(localStorage.getItem("lastAdTimestamp")||0),updateLabelMusic(),updateLabelSound(),ysdk.getPlayer().then((e=>(game.player=e,loadCloudSave()))).catch((e=>{game.player={}})).then((()=>{let t=!0;for(let e=0;e<game.gridSize;e++){for(let a=0;a<game.gridSize;a++)if(game.grid[e][a]){t=!1;break}if(!t)break}t&&(setTimeout((()=>{spawnTile(),spawnTile()}),200),game.hasEnteredBefore||(game.currency=game.currencyStart,game.hasEnteredBefore=!0)),SoundManager.load("bg",["sound/music.mp3"],!0),SoundManager.load("destroy",["sound/destroy.mp3"]),SoundManager.load("swap",["sound/swap.mp3"]),SoundManager.load("undo",["sound/undo.mp3"]),SoundManager.load("levelUp",["sound/levelUp.mp3"]),SoundManager.load("succes",["sound/succes.mp3"]),SoundManager.sounds.bg.addEventListener("canplaythrough",(()=>{game.musicReady=!0})),startGame(),setupInput(),window.addEventListener("resize",(()=>{syncTileSizeWithCell()})),PlayerStatsManager.init(),document.getElementById("undo-button").addEventListener("click",undoMove),document.getElementById("destroy-button").addEventListener("click",enterDestroyMode),document.getElementById("swap-button").addEventListener("click",enterSwapMode),document.getElementById("ad-button").addEventListener("click",(()=>showAdsVideo("game"))),document.getElementById("settings-button").addEventListener("click",openSettings),document.getElementById("new-game-btn").addEventListener("click",restartGame),document.getElementById("watch-ad-btn").addEventListener("click",(()=>showAdsVideo("settings"))),document.getElementById("toggle-music-btn").addEventListener("click",toggleMusic),document.getElementById("toggle-sound-btn").addEventListener("click",toggleSound),document.getElementById("close-settings-btn").addEventListener("click",closeSettingsOverlay),document.addEventListener("click",tryStartMusic),window.addEventListener("touchstart",tryStartMusic),window.addEventListener("keydown",tryStartMusic),document.body.addEventListener("click",tryStartMusic,{once:!0}),document.getElementById("display-mode").addEventListener("change",(e=>{const t=e.target.value,a=document.querySelector(`#display-mode option[value="${t}"]`).textContent;document.getElementById("display-mode-fake").textContent=a,setDisplayMode(t)})),game.lastClaimDate=new Date,e&&e()}))}function closeSettingsOverlay(){const e=game.settingsOverlay.querySelector(".settings-content");gsap.to(e,{scale:.5,opacity:0,duration:.3,ease:"back.in(1.7)",onComplete:()=>{game.settingsOverlay.classList.add("hidden"),game.isPaused=!1}})}function loadCloudSave(){return game.player.getData().then((e=>{const t=e;if(t&&(t.currency&&(game.currency=t.currency),t.bestScore&&(game.bestScore=t.bestScore),t.hasEnteredBefore&&(game.hasEnteredBefore=t.hasEnteredBefore),t.displayMode&&setDisplayMode(t.displayMode),t.lastClaimDate&&(game.lastClaimDate=new Date(t.lastClaimDate)),t.lastDailyReward&&(game.lastDailyReward=new Date(t.lastDailyReward)),t.currentGame)){const e=t.currentGame;game.score=e.score,game.highestLevelReached=e.highestLevelReached;for(let t=0;t<game.gridSize;t++)for(let a=0;a<game.gridSize;a++){const n=e.grid[t][a];if(n){const e=document.createElement("div");e.className="tile",e.innerHTML='\n                              <div class="tile-inner">\n                                <div class="tile-sprite"></div>\n                                <div class="tile-level"></div>\n                              </div>',e.dataset.value=n.value,e.dataset.level=getLevel(n.value),updateFontSize(e,n.value),game.grid[t][a]={el:e,value:n.value},setTilePosition(e,t,a),styleTile(e,n.value),setTileSprite(e.querySelector(".tile-sprite"),n.value)}}const a=(e.history||[]).map((e=>({score:e.score,highestLevelReached:e.highestLevelReached,grid:e.grid.map((e=>e.map((e=>e?{value:e.value}:null))))})));game.historyStack.length=0,game.historyStack.push(...a)}}))}function initDefaultSettings(){game.predefinedTileColors={1:["#eee4da","#776e65"],2:["#ede0c8","#776e65"],3:["#f2b179","#f9f6f2"],4:["#f59563","#f9f6f2"],5:["#f67c5f","#f9f6f2"],6:["#f65e3b","#f9f6f2"],7:["#edcf72","#f9f6f2"],8:["#edcc61","#f9f6f2"],9:["#edc850","#f9f6f2"],10:["#edc53f","#f9f6f2"],11:["#edc22e","#f9f6f2"],12:["#d4af37","#f9f6f2"],13:["#b8860b","#f9f6f2"],14:["#a97142","#f9f6f2"],15:["#8b4513","#f9f6f2"]},game.bestScore=0,game.score=0,game.currency=0,game.hasEnteredBefore=!1,game.historyStack=[],game.isPlaying=!1,game.isPaused=!1,game.isMusicOn=!1,game.musicReady=!1,game.musicStarted=!1,game.lastClaimDate=new Date,game.lastAdTimestamp=0,game.lastInteractionTime=null,game.displayMode=setDisplayMode(game.typeModes.value)}function startGame(){updateBestScoreDisplay(),updateCurrencyDisplay(),updateScoreDisplay(),game.isPlaying=!0}function updateBestScoreDisplay(){game.elBestScore&&(game.elBestScore.textContent=game.bestScore)}function updateCurrencyDisplay(){game.elCurrency&&(game.elCurrency.textContent=game.currency)}function updateScoreDisplay(){game.elScore&&(game.elScore.textContent=game.score)}function showLevelUpPopup(e){const t=document.getElementById("level-up-popup"),a=document.getElementById("level-up-img"),n=document.getElementById("level-up-text"),o=`images/helper_${Math.floor(8*Math.random())+1}.png`,s=game.preloaderImages[o];s&&a&&(a.src=s.src),n.textContent=getRandomLevelUpPhrase(),t.classList.remove("hidden"),game.isPlaying=!1,gsap.fromTo(t,{scale:.5,opacity:0},{scale:1,opacity:1,duration:.7,ease:"back.out(1.7)",onComplete:()=>{setTimeout((()=>{gsap.to(t,{scale:.5,opacity:0,duration:.3,ease:"back.in(1.7)",onComplete:()=>{t.classList.add("hidden"),game.isPlaying=!0}})}),700)}})}function computeActions(e){const t=[];let a=!1,n=0;const o=game.grid.map((e=>e.map((e=>e?{...e}:null))));const s=(e,t)=>o[e]?.[t],l={ArrowLeft:{vertical:!1,reverse:!1},ArrowRight:{vertical:!1,reverse:!0},ArrowUp:{vertical:!0,reverse:!1},ArrowDown:{vertical:!0,reverse:!0}}[e];if(!l)return{actions:t,moved:a,currency:n};for(let e=0;e<game.gridSize;e++){let o=[];for(let t=0;t<game.gridSize;t++){const a=l.vertical?t:e,n=l.vertical?e:t,i=s(a,n);i&&o.push({...i,r:a,c:n})}l.reverse&&o.reverse();const i=[];let r=0;for(;r<o.length;){const s=o[r],d=o[r+1],c=i.length,m=l.reverse?game.gridSize-1-c:c,u=l.vertical?m:e,g=l.vertical?e:m;d&&s.value===d.value?(s.r==u&&s.c==g||t.push({from:s,from2:void 0,to:{r:u,c:g},value:s.value}),t.push({from:d,from2:s,to:{r:u,c:g},value:2*s.value}),i.push({value:2*s.value}),n+=Math.round(getLevel(2*s.value)/4),r+=2,a=!0):(s.r===u&&s.c===g||(t.push({from:s,from2:void 0,to:{r:u,c:g},value:s.value}),a=!0),i.push({value:s.value}),r++)}}return{actions:t,moved:a,currency:n}}function move(e){if(!game.isPlaying)return;if(game.isMove)return;game.isMove=!0,setTimeout((()=>{game.isMove=!1}),250);const t=getSnapshotBoard(),{actions:a,moved:n,currency:o}=computeActions(e);let s={sound:!0};a.forEach((e=>{const t=getCellElement(e.to.r,e.to.c);if(e.from2){const a=e.from.el,n=getCellElement(e.from.r,e.from.c);game.grid[e.to.r][e.to.c]={el:a,value:e.value},game.grid[e.from.r][e.from.c]=null,animateTileMovement(a,t,(()=>{n.contains(a)&&n.removeChild(a),t.contains(e.from2.el)&&t.removeChild(e.from2.el),e.from2.el.remove(),a.className="tile",a.innerHTML='\n          <div class="tile-inner pop">\n            <div class="tile-sprite"></div>\n            <div class="tile-level"></div>\n          </div>',a.dataset.value=e.value,a.dataset.level=getLevel(e.value),updateFontSize(a,e.value),setTimeout((()=>{a.querySelector(".tile-inner.pop").classList.remove("pop")}),150),styleTile(a,e.value),setTileSprite(a.querySelector(".tile-sprite"),e.value),t.appendChild(a)}))?.then((()=>{addScore(e.value),checkWin(game.grid[e.to.r][e.to.c],s)}))}else{const a=e.from.el,n=getCellElement(e.from.r,e.from.c);game.grid[e.to.r][e.to.c]={el:a,value:e.value},game.grid[e.from.r][e.from.c]=null,animateTileMovement(a,t,(()=>{n.contains(a)&&n.removeChild(a),t.appendChild(a)}))}})),n?setTimeout((()=>{game.currency+=o,updateCurrencyDisplay(),spawnTile(),pushToHistory(t),PlayerStatsManager.prepareChanges(),checkGameOver()}),150):checkGameOver()}function cloneGrid(e){return e.map((e=>e.map((e=>e?{el:e.el,value:e.value}:null))))}function getCellElement(e,t){return document.querySelector(`.cell[data-row="${e}"][data-col="${t}"]`)}function checkGameOver(){for(let e=0;e<game.gridSize;e++)for(let t=0;t<game.gridSize;t++){if(!game.grid[e][t])return!1;const a=game.grid[e][t].value;if(e>0&&game.grid[e-1][t]?.value===a||e<game.gridSize-1&&game.grid[e+1][t]?.value===a||t>0&&game.grid[e][t-1]?.value===a||t<game.gridSize-1&&game.grid[e][t+1]?.value===a)return!1}return showGameOverOverlay(),!0}function showGameOverOverlay(){const e=document.getElementById("game-over-overlay");e.classList.remove("hidden"),game.isPaused=!0,document.getElementById("go-destroy").onclick=()=>{e.classList.add("hidden"),game.isPaused=!1,enterDestroyMode()},document.getElementById("go-swap").onclick=()=>{e.classList.add("hidden"),game.isPaused=!1,enterSwapMode()},document.getElementById("go-watch-ad").onclick=()=>{e.classList.add("hidden"),game.isPaused=!1,showAdsVideo("game")},document.getElementById("go-restart").onclick=()=>{e.classList.add("hidden"),game.isPaused=!1,restartGame()}}function spawnTile(){const e=[];for(let t=0;t<game.gridSize;t++)for(let a=0;a<game.gridSize;a++)game.grid[t][a]||e.push({r:t,c:a});if(0===e.length)return;const{r:t,c:a}=e[Math.floor(Math.random()*e.length)],n=Math.random()<.9?2:4,o=document.createElement("div");o.className="tile",o.innerHTML='\n      <div class="tile-inner pop">\n        <div class="tile-sprite"></div>\n        <div class="tile-level"></div>\n      </div>',o.dataset.value=n,o.dataset.level=getLevel(n),updateFontSize(o,n),game.grid[t][a]={el:o,value:n},setTilePosition(o,t,a),styleTile(o,n),setTileSprite(o.querySelector(".tile-sprite"),n),setTimeout((()=>{o.querySelector(".tile-inner.pop").classList.remove("pop")}),150)}function checkWin(e,t){const a=getLevel(e.value);if(a>3&&t.sound&&(SoundManager.play("levelUp"),t.sound=!1),a>4&&(e.el.classList.add("selected"),setTimeout((()=>{e.el.classList.remove("selected")}),400)),a>5){const t=e.el.getBoundingClientRect();playVictoryParticles(t.left+t.width/2,t.top+t.height/2)}a>game.highestLevelReached&&(game.highestLevelReached=a,a>6&&showLevelUpPopup(a))}function createGrid(){for(let e=0;e<game.gridSize;e++){game.grid[e]=[];for(let t=0;t<game.gridSize;t++){const a=document.createElement("div");a.className="cell",a.dataset.row=e,a.dataset.col=t,game.gridElement.appendChild(a),game.grid[e][t]=null}}syncTileSizeWithCell()}function syncTileSizeWithCell(){adjustGameContainerMargin();const e=document.querySelector(".cell");if(!e)return;const t=e.getBoundingClientRect();game.tileSize=(e=>{const t=window.innerWidth,a=window.innerHeight;return e/Math.min(t,a)*100})(t.width),game.cellSize=game.tileSize+game.gap;document.documentElement.style.setProperty("--tile-size",`${game.tileSize.toFixed(2)}vmin`);for(let e=0;e<game.gridSize;e++)for(let t=0;t<game.gridSize;t++){const a=game.grid[e][t];a&&setTilePosition(a.el,e,t)}}function adjustGameContainerMargin(){const e=document.getElementById("game-wrapper"),t=document.querySelector(".top-panel"),a=document.querySelector(".game-container"),n=document.querySelector(".bottom-buttons");if(!(e&&t&&a&&n))return;const o=getComputedStyle(n),s=parseFloat(o.marginTop),l=e.clientHeight-t.offsetHeight-a.offsetHeight-(n.offsetHeight+s);if(l>0){const e=Math.min(l/window.innerHeight*100,15);a.style.marginTop=`${e}vmin`}else a.style.marginTop="0"}function setTilePosition(e,t,a){const n=game.gridElement.querySelector(`.cell[data-row="${t}"][data-col="${a}"]`);n&&n.appendChild(e)}function styleTile(e,t){const a=getLevel(t),[n,o]=getColorForLevel(a);e.style.background=n,e.style.color=o,e.style.background=n,e.style.color=o;const s=e.querySelector(".tile-level span");s&&(s.textContent=a),e.style.fontSize=t<100?"7vmin":t<1e3?"6vmin":"5vmin"}function setTileSprite(e,t){const a=getLevel(t);let n;if(a>33){n=`images/helper_${(a-34)%8+1}.png`}else{n=`images/set2/img_${Math.min(a,33)}.png`}const o=game.preloaderImages[n];o&&e&&(e.style.backgroundImage=`url('${o.src}')`)}function getRandomLevelUpPhrase(){return game.randomLevelUpPhrases[Math.floor(Math.random()*game.randomLevelUpPhrases.length)]}function loadingResources(e){let t=[];for(let e=1;e<34;e++)t.push(`images/set2/img_${e}.png`);for(let e=1;e<9;e++)t.push(`images/helper_${e}.png`);preloadImages(t,(()=>{fetch(`lang/${game.currentLang}.json`).then((e=>e.json())).then((t=>{game.translations=t,e()}))}))}function preloadImages(e,t){let a=0;const n=e.length;e.forEach((e=>{const o=new Image;o.onload=o.onerror=()=>{a++,a===n&&t()},o.src=e,game.preloaderImages[e]=o}))}function getLevel(e){if(game.log2Cache[e])return game.log2Cache[e];const t=Math.log2(e);return game.log2Cache[e]=t,t}function getColorForLevel(e){if(game.colorCache[e])return game.colorCache[e];let t;if(game.predefinedTileColors[e])t=game.predefinedTileColors[e];else{t=[`hsl(${35*e%360}, 70%, 60%)`,"#f9f6f2"]}return game.colorCache[e]=t,t}function addScore(e){game.score+=e,updateScoreDisplay(),game.score>game.bestScore&&(game.bestScore=game.score,updateBestScoreDisplay(),PlayerStatsManager.trySubmitScore(game.bestScore))}function setupInput(){let e,t;window.addEventListener("keydown",(e=>{game.isPaused||game.destroyMode||game.swapMode||!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)||(e.preventDefault(),move(e.key))}));window.addEventListener("touchstart",(a=>{const n=a.touches[0];e=n.clientX,t=n.clientY})),window.addEventListener("touchend",(a=>{const n=a.changedTouches[0],o=n.clientX-e,s=n.clientY-t;game.isPaused||game.destroyMode||game.swapMode||(Math.abs(o)>Math.abs(s)&&Math.abs(o)>30?move(o>0?"ArrowRight":"ArrowLeft"):Math.abs(s)>30&&move(s>0?"ArrowDown":"ArrowUp"))}),{passive:!1}),["click","keydown","touchstart"].forEach((e=>{document.addEventListener(e,(()=>{game.lastInteractionTime=Date.now()}))}))}function tryStartMusic(){if(game.musicStarted||!game.isMusicOn)return;const e=SoundManager.sounds.bg;if(e){if(!e.dataset?.initialized)return e.dataset=e.dataset||{},e.dataset.initialized=!0,void e.load();e.volume=.01,e.loop=!0,e.play().then((()=>{game.musicStarted=!0})).catch((e=>{})),document.removeEventListener("click",tryStartMusic),window.removeEventListener("touchstart",tryStartMusic),window.removeEventListener("keydown",tryStartMusic)}}function tryStartSound(){game.isSoundOn&&SoundManager.play("succes")}function getSnapshotBoard(){return{score:game.score,highestLevelReached:game.highestLevelReached,grid:game.grid.map((e=>e.map((e=>e?{value:e.value}:null))))}}function pushToHistory(e){game.historyStack.push(e),game.historyStack.length>game.HISTORY_LIMIT&&game.historyStack.shift()}function undoMove(){if(game.destroyMode||game.swapMode)return;const e=game.undoPrice;if(game.currency<e)return void showNoCurrencyOverlay();const t=game.historyStack.pop();if(t){SoundManager.play("undo"),game.currency-=e,game.score=t.score,game.highestLevelReached=t.highestLevelReached,updateScoreDisplay(),updateBestScoreDisplay(),updateCurrencyDisplay(),game.gridElement.innerHTML="",game.grid=[],createGrid();for(let e=0;e<game.gridSize;e++)for(let a=0;a<game.gridSize;a++){const n=t.grid[e][a];if(n){const t=document.createElement("div");t.className="tile",t.innerHTML='\n            <div class="tile-inner">\n              <div class="tile-sprite"></div>\n              <div class="tile-level"></div>\n            </div>',t.dataset.value=n.value,t.dataset.level=getLevel(n.value),updateFontSize(t,n.value),game.grid[e][a]={el:t,value:n.value},setTilePosition(t,e,a),styleTile(t,n.value),setTileSprite(t.querySelector(".tile-sprite"),n.value)}}PlayerStatsManager.prepareChanges()}}function enterDestroyMode(){if(game.destroyMode)return void exitDestroyMode();if(game.swapMode)return void exitSwapMode();const e=game.destroyPrice;game.currency<e?showNoCurrencyOverlay():(game.destroyMode=!0,updateHelperPanel("destroy-mode-panel"),game.destroyPanel.classList.remove("hidden"),setTimeout((()=>{document.addEventListener("click",handleDestroyClick)}),50))}function getTilePosition(e){const t=e.closest(".cell");if(!t)return null;return{row:parseInt(t.dataset.row,10),col:parseInt(t.dataset.col,10),cellEl:t}}function handleDestroyClick(e){let t=game.destroyMode;if(exitDestroyMode(),!t)return;const a=e.target.closest(".tile");if(!a)return;const n=getTilePosition(a);if(!n)return;let o=0;for(let e=0;e<game.gridSize;e++)for(let t=0;t<game.gridSize;t++)game.grid[e][t]&&o++;if(o<=1)return;game.currency-=100,updateCurrencyDisplay(),pushToHistory(getSnapshotBoard()),game.grid[n.row][n.col]=null,PlayerStatsManager.prepareChanges();const s=a.style.transform;a.style.transform="none";const l=a.getBoundingClientRect();a.style.transform=s;const i=game.gridElement.getBoundingClientRect(),r=(l.left,i.left,l.top,i.top,a.getBoundingClientRect()),d=r.top+r.width/2,c=r.left+r.height/2;SoundManager.play("destroy");for(let e=0;e<15;e++){const e=document.createElement("div");e.className="particle",e.style.boxShadow=`0 0 10px ${e.style.background}`,document.body.appendChild(e),e.style.top=d+"px",e.style.left=c+"px";const t=Math.random()*Math.PI*2,a=80+40*Math.random(),n=Math.cos(t)*a,o=Math.sin(t)*a;gsap.to(e,{x:n,y:o,opacity:0,scale:1+1.5*Math.random(),duration:.8,ease:"power2.out",onComplete:()=>e.remove()})}gsap.fromTo(a,{opacity:0,scale:.5},{opacity:1,scale:1.2,duration:.1,ease:"power2.out",onComplete:()=>{gsap.to(a,{opacity:0,scale:1.1,duration:.7,ease:"power3.in",onComplete:()=>{a.style.display="none",n.cellEl.removeChild(a),a.remove()}})}}),gsap.fromTo(a,{x:-30},{x:30,yoyo:!0,repeat:5,duration:.04,ease:"power1.inOut",onComplete:()=>{gsap.to(a,{x:0,duration:.05})}})}function exitDestroyMode(){game.destroyMode=!1,game.destroyPanel.classList.add("hidden"),document.removeEventListener("click",handleDestroyClick)}function updateHelperPanel(e){const t=Math.floor(8*Math.random())+1,a=document.getElementById(e).querySelector(".helper-img"),n=`images/helper_${t}.png`;game.preloaderImages[n];game.cachedImage&&a&&(a.src=game.cachedImage.src)}function enterSwapMode(){if(game.destroyMode)return void exitDestroyMode();if(game.swapMode)return void exitSwapMode();const e=game.swapPrice;game.currency<e?showNoCurrencyOverlay():(game.swapMode=!0,game.selectedTiles=[],game.swapPanel.classList.remove("hidden"),setTimeout((()=>{document.addEventListener("click",handleSwapClick)}),50))}function openSettings(){game.isPaused=!0;const e=Math.floor(8*Math.random())+1,t=game.settingsOverlay.querySelector(".settings-cat"),a=`images/helper_${e}.png`,n=game.preloaderImages[a];n&&t&&(t.src=n.src);const o=game.settingsOverlay.querySelector(".settings-content");game.settingsOverlay.classList.remove("hidden"),gsap.fromTo(o,{scale:.5,opacity:0},{scale:1,opacity:1,duration:.3,ease:"back.out(1.7)"})}function exitSwapMode(){game.swapMode=!1,game.swapPanel.classList.add("hidden"),document.removeEventListener("click",handleSwapClick),game.selectedTiles.forEach((e=>{game.grid[e.row][e.col].el.classList.remove("selected")})),game.selectedTiles=[]}function handleSwapClick(e){const t=e.target.closest(".tile");if(!t)return void exitSwapMode();const a=getTilePosition(t);if(a&&!game.selectedTiles.some((e=>e.row===a.row&&e.col===a.col))&&(game.selectedTiles.push(a),t.classList.add("selected"),2===game.selectedTiles.length)){const e=120;game.currency-=e,updateCurrencyDisplay(),pushToHistory(getSnapshotBoard());const[t,a]=game.selectedTiles,n=game.grid[t.row][t.col],o=game.grid[a.row][a.col];if(!n||!o)return;const s=n.el,l=o.el;animateTileMovement(s,a.cellEl,(()=>{t.cellEl.contains(s)&&t.cellEl.removeChild(s),a.cellEl.appendChild(s)})),animateTileMovement(l,t.cellEl,(()=>{a.cellEl.contains(l)&&a.cellEl.removeChild(l),t.cellEl.appendChild(l)})),SoundManager.play("swap"),[game.grid[t.row][t.col],game.grid[a.row][a.col]]=[o,n],s.classList.remove("selected"),l.classList.remove("selected"),game.selectedTiles=[],exitSwapMode(),PlayerStatsManager.prepareChanges()}}function showAdsVideo(e="game"){const t=game.videoReward;"settings"===e&&closeSettingsOverlay(),ysdk.adv.showRewardedVideo({callbacks:{onOpen:()=>{musicOnPause(!0)},onRewarded:()=>{game.currency+=t,showRewardPopup(`🎉 Вы получили <span class="reward-amount">+${t}</span> самоцветов!`,(()=>{updateCurrencyDisplay(),PlayerStatsManager.prepareChanges()}))},onClose:()=>{musicOnPause(!1),setTimeout((()=>{}),150)},onError:e=>{}}})}function t(e,t={}){let a=game.translations[e]||e;for(const e in t)a=a.replaceAll(`{${e}}`,t[e]);return a}function updateLangTexts(){document.getElementById("ad-button").title=t("getGems"),document.getElementById("undo-button").title=t("undo"),document.getElementById("destroy-button").title=t("destroy"),document.getElementById("swap-button").title=t("swap"),document.getElementById("settings-button").title=t("settings"),document.getElementById("new-game-btn").querySelector("span").textContent=t("newGame"),document.getElementById("watch-ad-btn").querySelector("span").textContent=t("getGems"),document.getElementById("toggle-music-btn").querySelector("span").textContent=t("music"),document.getElementById("toggle-sound-btn").querySelector("span").textContent=t("sound"),document.getElementById("close-settings-btn").querySelector("span").textContent=t("continue"),document.getElementById("go-destroy").querySelector("span").textContent=t("destroy"),document.getElementById("go-swap").querySelector("span").textContent=t("swap"),document.getElementById("go-watch-ad").querySelector("span").textContent=t("getGems"),document.getElementById("go-restart").querySelector("span").textContent=t("newGame"),document.getElementById("title-game-over-1").textContent=t("title-game-over-1"),document.getElementById("title-game-over-2").textContent=t("title-game-over-2"),game.randomNoCurrencyPhrases=t("randomNoCurrencyPhrases"),game.randomLevelUpPhrases=t("randomLevelUpPhrases"),document.getElementById("no-currency-watch-ad").querySelector("span").textContent=t("getGems"),document.getElementById("no-currency-close").querySelector("span").textContent=t("continue"),game.destroyPanel.querySelector("p").textContent=t("destroyInstruction"),game.swapPanel.querySelector("p").textContent=t("swapInstruction"),document.getElementById("display-mode-label").textContent=t("displayModeLabel"),document.getElementById("display-mode-level").textContent=t("displayModeLevel"),document.getElementById("display-mode-value").textContent=t("displayModeValue"),document.getElementById("ad-button").querySelector("span").textContent=`+${game.videoReward}`,document.getElementById("undo-button").querySelector("span").textContent=game.undoPrice,document.getElementById("destroy-button").querySelector("span").textContent=game.destroyPrice,document.getElementById("swap-button").querySelector("span").textContent=game.swapPrice}function restartGame(){game.score=0,game.historyStack.length=0,game.highestLevelReached=2,game.gridElement.innerHTML="",game.grid=[],createGrid(),setTimeout((()=>{spawnTile(),spawnTile(),PlayerStatsManager.prepareChanges(),game.lastClaimDate=new Date,game.isPaused=!1,game.isPlaying=!0}),500),updateBestScoreDisplay(),updateCurrencyDisplay(),updateScoreDisplay(),closeSettingsOverlay(),tryShowSmartAd("newgame")}function toggleMusic(){game.isMusicOn=!game.isMusicOn,localStorage.setItem("music",game.isMusicOn),updateLabelMusic(),SoundManager.toggleMusic(game.isMusicOn),game.isMusicOn?tryStartMusic():(SoundManager.pause("bg"),game.musicStarted=!1)}function toggleSound(){game.isSoundOn=!game.isSoundOn,localStorage.setItem("sound",game.isSoundOn),updateLabelSound(),SoundManager.toggleSound(game.isSoundOn),game.isSoundOn&&tryStartSound()}function updateLabelMusic(){document.getElementById("music-text").textContent=game.isMusicOn?t("musicOn"):t("musicOff");document.getElementById("music-icon").src=game.isMusicOn?"images/icon_music_on.png":"images/icon_music_off.png"}function updateLabelSound(){document.getElementById("sound-text").textContent=game.isSoundOn?t("soundOn"):t("soundOff");document.getElementById("sound-icon").src=game.isSoundOn?"images/icon_sound_on.png":"images/icon_sound_off.png"}function checkDailyReward(){const e=(new Date).toDateString();game.lastDailyReward&&game.lastDailyReward.toDateString()===e||setTimeout((()=>{const e=game.dailyReward;showRewardPopup(t("dailyReward",{amount:e}),(()=>{game.currency+=e,game.lastDailyReward=new Date,updateCurrencyDisplay()}))}),1e3)}function showRewardPopup(e,t){const a=document.createElement("div");a.className="level-up-popup",a.innerHTML=`\n    <img src="images/diamond.png" />\n    <p>${e}</p>\n  `,document.body.appendChild(a),gsap.fromTo(a,{scale:.5,opacity:0},{scale:1,opacity:1,duration:.6,ease:"back.out(1.7)",onComplete:()=>{setTimeout((()=>{gsap.to(a,{scale:.5,opacity:0,duration:.4,ease:"back.in(1.7)",onComplete:()=>{a.remove(),t&&t()}})}),2500)}})}function tryShowSmartAd(e="auto"){const t=Date.now();if(!(t-game.lastAdTimestamp>=3e5))return;("startup"===e||"newgame"===e||"auto"===e)&&(showFullscreenAd(),game.lastAdTimestamp=t,localStorage.setItem("lastAdTimestamp",t.toString()))}function showFullscreenAd(e=null){ysdk?.adv&&ysdk.adv.showFullscreenAdv({callbacks:{onOpen:()=>{musicOnPause(!0)},onClose:t=>{t&&(game.lastAdTimestamp=Date.now(),musicOnPause(!1)),e&&e?.()},onError:t=>{e&&e?.()}}})}function showNoCurrencyOverlay(){const e=game.randomNoCurrencyPhrases,t=e[Math.floor(Math.random()*e.length)];document.getElementById("no-currency-text").textContent=t;const a=document.getElementById("no-currency-overlay"),n=document.getElementById("no-currency-cat"),o=`images/helper_${Math.floor(8*Math.random())+1}.png`,s=game.preloaderImages[o];s&&n&&(n.src=s.src);const l=a.querySelector(".settings-content");gsap.fromTo(l,{scale:.5,opacity:0},{scale:1,opacity:1,duration:.4,ease:"back.out(1.7)"}),a.classList.remove("hidden"),game.isPaused=!0,document.getElementById("no-currency-close").onclick=()=>{a.classList.add("hidden"),game.isPaused=!1},document.getElementById("no-currency-watch-ad").onclick=()=>{a.classList.add("hidden"),showAdsVideo("settings")}}function musicOnPause(e=!0){game.isMusicOn&&game.musicReady&&(e?(SoundManager.pause("bg"),game.musicStarted=!1):tryStartMusic())}function playVictoryParticles(e,t){for(let a=0;a<50;a++){const a=document.createElement("div");a.className="particle",document.body.appendChild(a),a.style.left=`${e}px`,a.style.top=`${t}px`,a.style.background=`hsl(${360*Math.random()}, 90%, 60%)`;const n=Math.random()*Math.PI*2,o=40+40*Math.random(),s=Math.cos(n)*o,l=Math.sin(n)*o;gsap.to(a,{x:s,y:l,opacity:0,scale:.5+Math.random(),duration:.5+Math.random(),ease:"power2.out",onComplete:()=>a.remove()})}}function initTilePool(){game.tilePool=[];const e=document.getElementById("tile-animation-layer");for(let t=0;t<16;t++){const t=document.createElement("div");t.className="animation-tile",t.style.position="absolute",t.style.display="none",e.appendChild(t),game.tilePool.push(t)}}function getFreeAnimationTile(){return game.tilePool.find((e=>"none"===e.style.display))}function cleanAnimationTile(e){e.innerHTML="",e.style.background="",e.style.color="",e.style.fontSize="",e.style.zIndex="0",e.style.top="0",e.style.left="0",e.style.display="none",e.dataset.value="",e.dataset.level=""}function animateTileMovement(e,t,a){const n=getFreeAnimationTile();if(!n)return a?.();cleanAnimationTile(n);const o=e.getBoundingClientRect(),s=t.getBoundingClientRect(),l=document.getElementById("tile-animation-layer").getBoundingClientRect(),i=o.left-l.left,r=o.top-l.top,d=s.left-l.left,c=s.top-l.top;return n.innerHTML=e.innerHTML,n.style.background=e.style.background,n.style.color=e.style.color,n.style.fontSize=e.style.fontSize,n.style.transform="none",n.dataset.value=e.dataset.value,n.dataset.level=e.dataset.level,updateFontSize(n,e.dataset.value),gsap.set(n,{x:0,y:0,position:"absolute",zIndex:100,top:`${r}px`,left:`${i}px`,display:"block",onComplete:()=>{e.style.display="none"}}),gsap.to(n,{x:d-i,y:c-r,duration:.25,ease:"power1.inOut",onComplete:()=>{a?.(),n.style.display="none",n.style.transform="none",e.style.display=""}})}function updateTileFontSizes(){document.querySelectorAll(".tile").forEach((e=>{const t=e.querySelector(".tile-level span");if(!t)return;const a=.35*e.offsetWidth;t.style.fontSize=a+"px"}))}function setDisplayMode(e){const t=document.querySelector(".game-container");t.classList.remove("display-level","display-value"),t.classList.add("display-"+e),game.displayMode=e}function updateFontSize(e,t){const a=t.toString().length;e.classList.forEach((t=>{t.startsWith("len-")&&e.classList.remove(t)})),e.classList.add(`len-${a}`)}window.addEventListener("load",(()=>{YaGames.init().then((e=>{ysdk=e,game.lang=ysdk.environment.i18n.lang,game.currentLang=game.lang&&game.langs.includes(game.lang)?game.lang:game.langs.includes[0],document.documentElement.lang=game.currentLang,loadingResources((()=>{updateLangTexts(),initGame((()=>{checkDailyReward(),PlayerStatsManager.prepareChanges(),tryShowSmartAd("startup"),setInterval((()=>{tryShowSmartAd("auto")}),game.intervalSmartAd)}))}))}))}));